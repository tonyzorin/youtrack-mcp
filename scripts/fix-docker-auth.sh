#!/bin/bash

echo "ğŸ” Docker Hub OAuth Token Issue Diagnosis"
echo "=========================================="

echo ""
echo "âŒ Current Error:"
echo "failed to fetch oauth token: 401 Unauthorized"
echo ""

echo "This error means:"
echo "âœ… Docker login succeeded initially"
echo "âœ… Docker build completed successfully"
echo "âŒ Push failed due to OAuth token scope/permissions issue"
echo ""

echo "ğŸ”§ Possible Causes & Solutions:"
echo "==============================="
echo ""

echo "1. âŒ Token Permissions Insufficient"
echo "   â”œâ”€â”€ Current token may only have 'Read' permissions"
echo "   â”œâ”€â”€ Required: 'Read, Write, Delete' permissions"
echo "   â””â”€â”€ Solution: Regenerate token with full permissions"
echo ""

echo "2. âŒ Token Expired or Revoked"
echo "   â”œâ”€â”€ Token may have been automatically revoked"
echo "   â””â”€â”€ Solution: Create a new token"
echo ""

echo "3. âŒ Repository Permissions Issue"
echo "   â”œâ”€â”€ Token may not have access to youtrack-mcp repository"
echo "   â””â”€â”€ Solution: Verify repository access"
echo ""

echo "ğŸ”§ Step-by-Step Fix:"
echo "===================="
echo ""

echo "1. CREATE NEW TOKEN with Full Permissions:"
echo "   â”œâ”€â”€ Go to: https://hub.docker.com/settings/security"
echo "   â”œâ”€â”€ Click: 'New Access Token'"
echo "   â”œâ”€â”€ Description: 'GitHub Actions youtrack-mcp FULL'"
echo "   â”œâ”€â”€ Permissions: Select 'Read, Write, Delete' âœ“"
echo "   â”œâ”€â”€ Click: 'Generate'"
echo "   â””â”€â”€ Copy the new token immediately"
echo ""

echo "2. UPDATE GitHub Secret:"
echo "   â”œâ”€â”€ Go to: https://github.com/tonyzorin/youtrack-mcp/settings/secrets/actions"
echo "   â”œâ”€â”€ Find: DOCKER_PASSWORD"
echo "   â”œâ”€â”€ Click: 'Update'"
echo "   â”œâ”€â”€ Paste: New token with full permissions"
echo "   â””â”€â”€ Click: 'Update secret'"
echo ""

echo "3. VERIFY TOKEN LOCALLY (Optional):"
echo "   â”œâ”€â”€ Run: docker login -u tonyzorin"
echo "   â”œâ”€â”€ Enter: New token when prompted"
echo "   â”œâ”€â”€ Test: docker push tonyzorin/youtrack-mcp:test"
echo "   â””â”€â”€ Should succeed if token is correct"
echo ""

echo "ğŸ¯ Token Requirements Checklist:"
echo "================================"
echo ""
echo "âœ… Token must have 'Read, Write, Delete' permissions"
echo "âœ… Token must be for username 'tonyzorin'"
echo "âœ… Token must have access to 'youtrack-mcp' repository"
echo "âœ… Token must not be expired"
echo "âœ… Token must be copied exactly (no extra spaces)"
echo ""

echo "âš ï¸  Common Issues:"
echo "=================="
echo ""
echo "âŒ Selecting only 'Read' or 'Read, Write' permissions"
echo "âŒ Token created for wrong username"
echo "âŒ Token revoked due to security policy"
echo "âŒ Copy/paste errors with extra characters"
echo ""

echo "ğŸš€ After Fixing:"
echo "================"
echo ""
echo "1. Update DOCKER_PASSWORD secret with new token"
echo "2. Push any small change to trigger new workflow"
echo "3. Workflow should succeed with proper push permissions"
echo ""

echo "ğŸ’¡ Expected Success Output:"
echo "==========================="
echo ""
echo "âœ… Login Succeeded"
echo "âœ… Build completed"
echo "âœ… Push layers successful"
echo "âœ… Image pushed to tonyzorin/youtrack-mcp:0.4.0_wip"
echo "âœ… Docker build summary shows success" 